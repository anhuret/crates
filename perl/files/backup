#!/bin/sh

SRC=/data/safe/vault
DST=/data/fort/backup
STG=/data/safe/stage
MNT=$HOME/vault

STP="$(date +%y%m%d%H%M)"
RET="10"

function help {
  echo "Options:"
  echo -e "\t-r - restore latest vault"
  echo -e "\t-b - backup vault"
  echo -e "\t-g - encrypt glyphs only"
}

function glyph {
  echo "info: glyphs"

  if ! ls $STG $MNT &>/dev/null; then
    echo "error: missing directories"
    exit 1
  fi

  local name="glyphs"
  local file=${name}-${STP}.txz
  local crypt=${file}.asc

  if ! mountpoint -q $MNT; then
    echo "error: vault is NOT mounted for backup"
    exit 1
  fi

  cd $MNT
  if [[ $(pwd) != $MNT ]] || [[ ! -d $name ]]; then
    echo "error: $name is not found"
    exit 1
  fi

  tar -cJf $file $name
  if [[ $? != 0 ]] || [[ ! -f $file ]]; then
    echo "error: tar file"
    exit 1
  fi

  gpg -ca $file
  if [[ $? != 0 ]] || [[ ! -f $crypt ]] || [[ ! -s $crypt ]]; then
    echo "error: gpg file"
  else  
    cat $crypt
    mv $crypt ${STG}/${crypt}
  fi

  if [[ -f ${STG}/${crypt} ]]; then
    echo "info: success"
  fi
  rm -f $file
}

function backup {
  echo "info: backup"

  if ! ls $SRC $DST &>/dev/null; then
    echo "error: missing directories"
    exit 1
  fi

  local name="vault"
  local file=${DST}/${name}-${STP}.txz


  if mountpoint -q $MNT; then
    echo "error: vault is mounted"
    exit 1
  fi

  tar -cJvf $file -C ${SRC%/*} ${SRC##*/}
  if [[ $? != 0 ]]; then
    echo "error: archive"
    rm -f $file
    exit 1
  fi
  echo "info: success"

  local count=$(ls -1 ${DST}/vault* | wc -l)
  if [[ $count -gt $RET ]]; then
    echo "info: shaving"
    rm -f $(ls -1r ${DST}/vault* | tail -n +${RET})
  fi
}

function restore {
  echo "info: restore"

  if ! ls $DST &>/dev/null; then
    echo "error: missing backup directory"
    exit 1
  fi
  local pld=0

  if [[ -d $SRC ]]; then
    echo "warn: vault exists: saving"
    if [[ -d ${SRC}.old ]]; then
      echo "warn: old vault exists: removing"
      rm -rf ${SRC}.old
    fi
    mv $SRC ${SRC}.old
    if [[ $? != 0 ]]; then
      echo "error: create vault backup"
      exit 1
    else
      old=1
    fi
  fi

  local first=$(ls -1r $DST | head -n 1)
  echo "info: restoring $first"
  tar -xJvf ${DST}/${first} -C ${SRC%/*}
  if [[ ! -d $SRC ]]; then
    echo "error: restor"
    if [[ $pld == 1 ]]; then
      echo "info: restoring old"
      mv ${SRC}.old $SRC
    fi
  else
    echo "info: success"
    if [[ -d ${SRC}.old ]]; then
      echo "info: preserving saved vault"
      mv ${SRC}.old ${SRC}-${STP}.old
    fi
  fi
}

# Main #

case $1 in
  "-g")
    glyph
    ;;
  "-r")
    restore
    ;;
  "-b")
    backup
    ;;
  *)
    help
    ;;
esac
